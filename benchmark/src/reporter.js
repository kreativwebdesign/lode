import * as math from "mathjs";
import { calculateNinetyFiveConfidenceInterval } from "./stats.js";

const ROUNDING_PRECISION = 3;

const round = (number) => {
  return math.round(number, ROUNDING_PRECISION);
};

export const calculateFigure = (reports, selector) => {
  const optimizedValues = reports.map(({ optimizedReport }) =>
    selector(optimizedReport)
  );
  const baselineValues = reports.map(({ baselineReport }) =>
    selector(baselineReport)
  );

  return {
    optimizedMean: round(math.mean(optimizedValues)),
    optimizedVariance: round(math.variance(optimizedValues)),
    baselineMean: round(math.mean(baselineValues)),
    baselineVariance: round(math.variance(baselineValues)),
  };
};

/**
 * Generates a report for all samples.
 * @param {*} reports list of reports generated by the samples.
 */
export const generateHolisticReport = (reports) => {
  const {
    optimizedMean: optimizedMedianFpsMean,
    optimizedVariance: optimizedMedianFpsVariance,
    baselineMean: baselineMedianFpsMean,
    baselineVariance: baselineMedianFpsVariance,
  } = calculateFigure(reports, (report) => report.medianFps);

  const {
    upper: optimizedUpper,
    lower: optimizedLower,
  } = calculateNinetyFiveConfidenceInterval({
    mean: optimizedMedianFpsMean,
    variance: optimizedMedianFpsVariance,
    samples: reports.length,
  });

  const {
    upper: baselineUpper,
    lower: baselineLower,
  } = calculateNinetyFiveConfidenceInterval({
    mean: baselineMedianFpsMean,
    variance: baselineMedianFpsVariance,
    samples: reports.length,
  });

  const {
    optimizedMean: optimizedGpuTotalTimeMean,
    optimizedVariance: optimizedGpuTotalTimeVariance,
    baselineMean: baselineGpuTotalTimeMean,
    baselineVariance: baselineGpuTotalTimeVariance,
  } = calculateFigure(reports, (report) => report.gpuTotalTime);

  const {
    optimizedMean: optimizedTotalGpuEventsMean,
    optimizedVariance: optimizedTotalGpuEventsVariance,
    baselineMean: baselineTotalGpuEventsMean,
    baselineVariance: baselineTotalGpuEventsVariance,
  } = calculateFigure(reports, (report) => report.debug.totalGpuEvents);

  const {
    optimizedMean: optimizedTotalModelLoadDurationMean,
    optimizedVariance: optimizedTotalModelLoadDurationVariance,
    baselineMean: baselineTotalModelLoadDurationMean,
    baselineVariance: baselineTotalModelLoadDurationVariance,
  } = calculateFigure(reports, (report) => report.debug.totalModelLoadDuration);

  const {
    optimizedMean: optimizedTotalRendersMean,
    optimizedVariance: optimizedTotalRendersVariance,
    baselineMean: baselineTotalRendersMean,
    baselineVariance: baselineTotalRendersVariance,
  } = calculateFigure(reports, (report) => report.debug.totalRenders);

  const {
    optimizedMean: optimizedMedianRenderLoopDurationMean,
    optimizedVariance: optimizedMedianRenderLoopDurationVariance,
    baselineMean: baselineMedianRenderLoopDurationMean,
    baselineVariance: baselineMedianRenderLoopDurationVariance,
  } = calculateFigure(
    reports,
    (report) => report.debug.medianRenderLoopDuration
  );

  return {
    optimizedMedianFpsMean,
    optimizedMedianFpsVariance,
    optimizedLower: round(optimizedLower),
    optimizedUpper: round(optimizedUpper),

    baselineMedianFpsMean,
    baselineMedianFpsVariance,
    baselineLower: round(baselineLower),
    baselineUpper: round(baselineUpper),

    optimizedGpuTotalTimeMean,
    optimizedGpuTotalTimeVariance,

    baselineGpuTotalTimeMean,
    baselineGpuTotalTimeVariance,

    optimizedTotalGpuEventsMean,
    optimizedTotalGpuEventsVariance,
    baselineTotalGpuEventsMean,
    baselineTotalGpuEventsVariance,

    optimizedTotalModelLoadDurationMean,
    optimizedTotalModelLoadDurationVariance,
    baselineTotalModelLoadDurationMean,
    baselineTotalModelLoadDurationVariance,

    optimizedTotalRendersMean,
    optimizedTotalRendersVariance,
    baselineTotalRendersMean,
    baselineTotalRendersVariance,

    optimizedMedianRenderLoopDurationMean,
    optimizedMedianRenderLoopDurationVariance,
    baselineMedianRenderLoopDurationMean,
    baselineMedianRenderLoopDurationVariance,
  };
};
